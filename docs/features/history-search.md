# 履歴全文検索

**カテゴリ**: 基本機能強化 | **優先度**: 任意

**前提**: `history.md`（基本履歴機能）

SQLite FTS5によるテキスト全文検索機能。大量の履歴から素早く目的のテキストを見つける。

---

## 目的

- キーワードによる履歴検索
- 大量の履歴でも高速な検索
- 日本語テキストの検索対応

---

## 技術選定

### SQLite FTS5 Contentless

全文検索にはSQLite FTS5のcontentlessモードを使用する。

| 特徴 | 説明 |
|------|------|
| 容量効率 | 本文は圧縮BLOB、FTSはインデックスのみ（重複なし） |
| 高速検索 | インデックス済みで大量の履歴でも高速 |
| 日本語対応 | ICUトークナイザーまたはtrigramで対応 |
| バックアップ容易 | 単一ファイル（history.db） |

### 日本語トークナイザー

| 方式 | メリット | デメリット |
|------|----------|------------|
| ICU | 形態素解析で精度高い | ビルド時にICU必要 |
| trigram | ビルド依存なし | インデックスサイズ大 |

**推奨**: まずtrigramで実装し、必要に応じてICUに移行。

---

## データ構造

### テーブル追加

| テーブル | 用途 |
|----------|------|
| `history_fts` | 検索インデックスのみ（contentless） |

### 検索フロー

1. `history_fts`で検索 → ヒットしたIDリスト取得
2. `history`テーブルからID指定で取得
3. 圧縮テキストを展開して表示

---

## 機能

### テキスト検索

- キーワード入力で全文検索
- 複数キーワードのAND検索
- 検索結果のハイライト表示

### 検索UI操作

| 項目 | 仕様 |
|------|------|
| 検索実行 | Enterキー |
| 最小文字数 | 3文字（trigram制約） |
| クリア | ×ボタン or Escapeキー |

---

## テスト要件

### TypeScript (Vitest)

| テスト | 内容 |
|--------|------|
| 検索 | キーワードで絞り込める |
| 検索結果表示 | ヒットした履歴が一覧表示される |

### Rust (cargo test)

| テスト | 内容 |
|--------|------|
| FTS初期化 | FTS5 contentlessテーブルが作成される |
| インデックス登録 | 履歴保存時にFTSインデックスが作成される |
| 全文検索 | FTS5で日本語検索ができる |
| 検索→取得 | 検索ヒット→ID取得→本文展開のフローが動く |
| インデックス削除 | 履歴削除時にFTSインデックスも削除される |

---

## 実装内容

### Backend (Rust)

1. **検索モジュール拡張** (`src-tauri/src/history/search.rs`)
   - FTS5テーブル初期化
   - インデックス登録・削除
   - 検索クエリ実行

2. **Tauriコマンド追加**
   - `history:search` - テキスト検索

### Frontend (TypeScript)

1. **型定義追加** (`src/types/history.ts`)
   - SearchQuery, SearchResult

2. **Primitives拡張** (`src/primitives/createHistory.ts`)
   - 検索状態管理
   - 検索結果キャッシュ

3. **UIコンポーネント追加**
   - SearchBar - 検索バー
   - SearchResults - 検索結果一覧

---

## 依存関係

### 前提機能

- `history.md` - 基本履歴機能

### Rust crates

| Crate | 用途 |
|-------|------|
| rusqlite | SQLite FTS5対応 |

---

## 作成ファイル

| ファイル | 説明 |
|----------|------|
| `src-tauri/src/history/search.rs` | 検索モジュール（Rust） |
| `src/components/history/SearchBar.tsx` | 検索バー |

---

## 完了条件

- [ ] FTS5 contentlessテーブルが作成される
- [ ] 履歴保存時にインデックスが登録される
- [ ] キーワードで全文検索ができる
- [ ] 日本語テキストが検索できる
- [ ] 履歴削除時にインデックスも削除される
- [ ] `pnpm test` で全テストが通る
- [ ] `cargo test` で全テストが通る
