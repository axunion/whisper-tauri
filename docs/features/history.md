# 履歴管理

**カテゴリ**: 基本機能強化 | **優先度**: 推奨

文字起こし結果と録音データを保存・管理する履歴機能。

---

## 目的

- 過去の文字起こし結果を閲覧・再利用
- 録音データの保存（容量上限あり）
- 履歴の検索・フィルタ
- 不要な履歴の削除

---

## データ保存

### 保存先

OS標準のアプリデータフォルダを使用：
- macOS: `~/Library/Application Support/com.whisper-tauri.app/`
- Windows: `%APPDATA%/com.whisper-tauri.app/`
- Linux: `~/.local/share/com.whisper-tauri.app/`

### 保存形式

| データ | 形式 | 説明 |
|--------|------|------|
| メタデータ | SQLite | ID、日時、ファイル名、言語、モデル |
| テキスト | SQLite (gzip BLOB) | 圧縮して保存 |
| セグメント | SQLite (gzip BLOB) | タイムスタンプ付きセグメント（圧縮JSON） |
| 検索インデックス | FTS5 contentless | 検索用インデックスのみ |
| 録音 | Opusファイル | `audio/{id}.opus` として保存（オプション） |

### SQLite + FTS5 Contentless

全文検索にはSQLite FTS5のcontentlessモードを使用する。

| 特徴 | 説明 |
|------|------|
| 容量効率 | 本文は圧縮BLOB、FTSはインデックスのみ（重複なし） |
| 高速検索 | インデックス済みで大量の履歴でも高速 |
| 日本語対応 | ICUトークナイザーまたはtrigramで対応 |
| バックアップ容易 | 単一ファイル（history.db） |

**テーブル構成:**

| テーブル | 用途 |
|----------|------|
| `history` | メタデータ + 圧縮テキスト（BLOB） |
| `history_fts` | 検索インデックスのみ（contentless） |

**検索フロー:**
1. `history_fts`で検索 → ヒットしたIDリスト取得
2. `history`テーブルからID指定で取得
3. 圧縮テキストを展開して表示

### 録音データの圧縮

WAVをそのまま保存すると容量が大きいため、Opus形式に変換して保存する。

| 形式 | 圧縮率 | 選定理由 |
|------|--------|----------|
| Opus | 約1/10〜1/20 | 音声に最適、低ビットレート（64kbps）でも高品質 |

### 容量管理

- 録音データの保存上限: ユーザー設定可能（デフォルト: 500MB）
- 上限超過時の動作: 古い**録音データ**から自動削除（テキストは保持）
- テキストデータは自動削除対象外（容量カウントにも含めない）

---

## 機能

### 1. 履歴一覧

- 日時順で一覧表示
- サムネイル情報（日時、ファイル名、テキスト冒頭）
- 録音データ有無のアイコン表示

### 2. 検索・フィルタ

- テキスト全文検索（圧縮展開して検索）
- 日付範囲フィルタ
- 録音データ有無でフィルタ

### 3. 履歴詳細

- 文字起こし結果の全文表示
- 録音データの再生（保存されている場合）
- エクスポート機能との連携（TXT/SRT/VTT）
- SLM処理機能との連携（校正・要約）

### 4. 削除

- 個別削除
- 複数選択削除
- 全削除（確認ダイアログ付き）
- 録音データのみ削除（テキストは残す）

---

## テスト要件

### TypeScript (Vitest)

| テスト | 内容 |
|--------|------|
| 履歴一覧取得 | 日時降順でソートされる |
| 検索 | キーワードで絞り込める |
| フィルタ | 日付範囲で絞り込める |
| 容量計算 | 録音データの合計サイズを正しく計算 |

### Rust (cargo test)

| テスト | 内容 |
|--------|------|
| DB初期化 | history + FTS5 contentlessテーブルが作成される |
| 保存 | テキストが圧縮されてDBに保存される |
| 全文検索 | FTS5で日本語検索ができる |
| 検索→取得 | 検索ヒット→ID取得→本文展開のフローが動く |
| 削除 | 履歴削除時にFTSインデックスも削除される |
| 容量管理 | 録音データの上限超過を正しく検知 |
| 音声変換 | WAVがOpus形式に変換される |
| 自動削除 | 上限超過時に古い録音のみ削除される（テキストは残る） |

---

## 実装内容

### Backend (Rust)

1. **履歴モジュール** (`src-tauri/src/history/`)
   - 保存・読み込み・削除
   - gzip圧縮・展開
   - 容量管理

2. **Tauriコマンド**
   - `history:list` - 履歴一覧取得
   - `history:get` - 履歴詳細取得
   - `history:save` - 履歴保存
   - `history:delete` - 履歴削除
   - `history:search` - テキスト検索
   - `history:get_storage_info` - 容量情報取得

### Frontend (TypeScript)

1. **型定義** (`src/types/history.ts`)
   - HistoryEntry, HistoryMeta, SearchQuery, StorageInfo

2. **Primitives** (`src/primitives/createHistory.ts`)
   - 履歴一覧の状態管理
   - 検索・フィルタ状態
   - 削除操作

3. **UIコンポーネント**
   - HistoryPage - 履歴ページ全体
   - HistoryList - 履歴一覧
   - HistoryItem - 履歴アイテム
   - HistoryDetail - 履歴詳細表示
   - SearchBar - 検索バー
   - StorageIndicator - 容量表示

---

## UI設計

### 履歴ページ

```
┌─────────────────────────────────────┐
│ [検索バー] [日付フィルタ] [容量: 250MB/500MB] │
├─────────────────────────────────────┤
│ ☐ 2024-01-15 14:30  meeting.wav    │
│   「本日の会議では...」      🎤     │
├─────────────────────────────────────┤
│ ☐ 2024-01-14 10:00  interview.wav  │
│   「インタビューを始め...」  🎤     │
├─────────────────────────────────────┤
│ [選択削除] [全選択]                 │
└─────────────────────────────────────┘
```

### 設定項目

- 録音データ保存上限（MB単位）
- 上限超過時の動作（古い録音を自動削除 / 警告のみ）
- 録音データを自動保存するか
- Opus圧縮品質（ビットレート）

---

## 依存関係

### Rust crates

| Crate | 用途 |
|-------|------|
| rusqlite | SQLite操作（FTS5対応） |
| flate2 | gzip圧縮・展開（テキストBLOB用） |
| opus | Opus音声エンコード |
| ogg | OGGコンテナ（Opus保存用） |

### 既存機能との連携

- エクスポート機能: 履歴からエクスポート可能
- SLMテキスト処理: 履歴データに対して校正・要約
- 設定永続化: 容量設定の保存

---

## 作成ファイル

| ファイル | 説明 |
|----------|------|
| `src-tauri/src/history/` | 履歴モジュール（Rust） |
| `src/types/history.ts` | 型定義 |
| `src/primitives/createHistory.ts` | SolidJS Primitive |
| `src/components/history/` | UIコンポーネント |
| `src/pages/HistoryPage.tsx` | 履歴ページ |

---

## 完了条件

- [ ] 文字起こし結果がSQLiteに圧縮保存される
- [ ] FTS5 contentlessで全文検索ができる（日本語対応）
- [ ] 録音データをOpus形式で圧縮保存できる（オプション）
- [ ] 履歴一覧を表示できる
- [ ] テキスト検索ができる
- [ ] 日付フィルタができる
- [ ] 個別削除ができる
- [ ] 複数選択削除ができる
- [ ] 容量上限を設定できる
- [ ] 現在の使用容量を確認できる
- [ ] 上限超過時に古い録音データのみ自動削除される（テキストは残る）
- [ ] `pnpm test` で全テストが通る
- [ ] `cargo test` で全テストが通る
